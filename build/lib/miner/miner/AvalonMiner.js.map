{
  "version": 3,
  "sources": ["../../../../src/lib/miner/miner/AvalonMiner.ts"],
  "sourcesContent": ["import {PollingMiner} from './PollingMiner';\nimport {AvalonMinerSettings} from '../model/MinerSettings';\nimport {MinerStats} from '../model/MinerStats';\nimport {MinerFeatureKey} from '../model/MinerFeature';\nimport {sendSocketCommand, sendRawSocketCommand} from '../../utils/socket-utils';\n\n// Avalon miners use CGMiner-compatible API\n// Reference: https://github.com/c7ph3r10/ha_avalonq\nenum AvalonMinerCommand {\n    stats = 'stats',\n    litestats = 'litestats',\n    summary = 'summary',\n    pools = 'pools',\n    devs = 'devs',\n    coin = 'coin',\n    version = 'version',\n    config = 'config'\n}\n\n// Avalon-specific commands using ascset format\nenum AvalonControlCommand {\n    workmode_eco = 'ascset|0,workmode,set,0',\n    workmode_standard = 'ascset|0,workmode,set,1',\n    workmode_super = 'ascset|0,workmode,set,2',\n    lcd_on = 'ascset|0,lcd,0:1',\n    lcd_off = 'ascset|0,lcd,0:0',\n    reboot = 'ascset|0,reboot,0'\n}\n\n// Timestamp offset in seconds for Avalon soft on/off commands\n// The timestamp must be slightly in the future for the command to be accepted\nconst TIMESTAMP_OFFSET_SECONDS = 5;\n\nexport class AvalonMiner extends PollingMiner<AvalonMinerSettings> {\n    public override async init(): Promise<void> {\n        await super.init();\n        // Avalon uses CGMiner API which does not support persistent connections\n        // Socket is closed after each command, so no connection initialization needed\n        return Promise.resolve();\n    }\n\n    public override async start(): Promise<void> {\n        // Wake up from standby mode using softon command with timestamp\n        const timestamp = Math.floor(Date.now() / 1000) + TIMESTAMP_OFFSET_SECONDS;\n        await this.sendControlCommand(`ascset|0,softon,1:${timestamp}`);\n    }\n\n    public override async fetchStats(): Promise<MinerStats> {\n        try {\n            // Fetch multiple stats similar to the HA addon\n            const [summary, stats, pools] = await Promise.all([\n                this.sendCommand<object>(AvalonMinerCommand.summary, '', true),\n                this.sendCommand<object>(AvalonMinerCommand.stats, '', true),\n                this.sendCommand<object>(AvalonMinerCommand.pools, '', true)\n            ]);\n\n            return {\n                raw: {\n                    summary,\n                    stats,\n                    pools\n                }\n            };\n        } catch (e) {\n            return Promise.reject(e);\n        }\n    }\n\n    public override async stop(): Promise<void> {\n        // Send to standby mode using softoff command with timestamp\n        const timestamp = Math.floor(Date.now() / 1000) + TIMESTAMP_OFFSET_SECONDS;\n        await this.sendControlCommand(`ascset|0,softoff,1:${timestamp}`);\n    }\n\n    /**\n     * Set workmode for the miner\n     * @param mode - 'eco' (0), 'standard' (1), or 'super' (2)\n     */\n    public async setWorkmode(mode: 'eco' | 'standard' | 'super'): Promise<void> {\n        const commandMap = {\n            eco: AvalonControlCommand.workmode_eco,\n            standard: AvalonControlCommand.workmode_standard,\n            super: AvalonControlCommand.workmode_super\n        };\n        await this.sendControlCommand(commandMap[mode]);\n    }\n\n    /**\n     * Control LCD display\n     * @param on - true to turn on, false to turn off\n     */\n    public async setLCD(on: boolean): Promise<void> {\n        const command = on ? AvalonControlCommand.lcd_on : AvalonControlCommand.lcd_off;\n        await this.sendControlCommand(command);\n    }\n\n    /**\n     * Reboot the miner\n     */\n    public async reboot(): Promise<void> {\n        await this.sendControlCommand(AvalonControlCommand.reboot);\n    }\n\n    public override getSupportedFeatures(): MinerFeatureKey[] {\n        return [\n            MinerFeatureKey.running,\n            MinerFeatureKey.rawStats\n        ];\n    }\n\n    public override getLoggerName(): string {\n        return `${super.getLoggerName()}AvalonMiner[${this.settings.host}:${this.settings.port}]`;\n    }\n\n    public override getCliArgs(): string[] {\n        return [];\n    }\n\n    private async sendCommand<T = void>(command: AvalonMinerCommand, parameter: string = '', expectResponse: boolean = true): Promise<T> {\n        return sendSocketCommand(this.logger, this.settings.host, this.settings.port, {\n            command,\n            parameter\n        }, expectResponse);\n    }\n\n    private async sendControlCommand(command: string): Promise<void> {\n        // Control commands use raw string format (ascset format), not JSON\n        return sendRawSocketCommand(this.logger, this.settings.host, this.settings.port, command, false);\n    }\n}\n"],
  "mappings": "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",
  "names": ["AvalonMinerCommand", "AvalonControlCommand"]
}

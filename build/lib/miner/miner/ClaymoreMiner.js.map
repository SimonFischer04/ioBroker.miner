{
  "version": 3,
  "sources": ["../../../../src/lib/miner/miner/ClaymoreMiner.ts"],
  "sourcesContent": ["import type { ClaymoreMinerSettings } from '../model/MinerSettings';\nimport { PollingMiner } from './PollingMiner';\nimport { safeParseInt } from '../../utils/parse-utils';\nimport { MinerFeatureKey } from '../model/MinerFeature';\nimport type { MinerStats } from '../model/MinerStats';\nimport { sendSocketCommand } from '../../utils/socket-utils';\n\nenum ClaymoreCommandMethod {\n    minerGetStat1 = 'miner_getstat1',\n    // TRM example response: {\"id\":0, \"result\":[\"0.10.20 - kawpow\", \"2672\", \"48301;5;0\", \"48301\", \"0;0;0\", \"off\", \"69;62\", \"kawpow.auto.nicehash.com:443\", \"0;0;0;0\", \"5\", \"0\", \"0\", \"0\", \"0\", \"0\", \"3\", \"1;1;1\", \"0\"], \"error\":null}\n    minerGetStat2 = 'miner_getstat2',\n\n    minerGetFile = 'miner_getfile',\n    // TRM: default (like any 'non_existent' method): \"CM API rpc method 'non_existent' is not supported.\"\n    minerFile = 'miner_file', // ATTENTION! RCE VULNERABILITY, DO NOT USE THIS METHOD (not supported by trm)\n\n    // TRM: \"CM API miner restart rpc is not supported.\"\n    minerRestart = 'miner_restart',\n\n    // TRM: \"CM API miner reboot rpc is not supported.\"\n    minerReboot = 'miner_reboot',\n\n    controlGpu = 'control_gpu',\n}\n\nexport class ClaymoreMiner extends PollingMiner<ClaymoreMinerSettings> {\n    public override async init(): Promise<void> {\n        await super.init();\n        // claymore api does not support persistent connections (socket is closed after each command), so don't need to init any connection here\n        return Promise.resolve();\n    }\n\n    public override async start(): Promise<void> {\n        await this.sendCommand(ClaymoreCommandMethod.controlGpu, ['-1', '1'], false);\n    }\n\n    public override async fetchStats(): Promise<MinerStats> {\n        try {\n            const response: MinerGetStat2Response = await this.sendCommand(\n                ClaymoreCommandMethod.minerGetStat2,\n                undefined,\n                true,\n            );\n            const parsedResponse: ParsedMinerGetStat2Response = this.parseMinerGetStat2(response);\n            this.logger.debug(`parsed response: ${JSON.stringify(parsedResponse)}`);\n\n            return {\n                raw: response,\n                version: parsedResponse.minerVersion,\n                totalHashrate: parsedResponse.ethTotal.hashrate * 1000,\n            };\n        } catch (e) {\n            // forward error\n            return Promise.reject(e);\n        }\n    }\n\n    public override async stop(): Promise<void> {\n        await this.sendCommand(ClaymoreCommandMethod.controlGpu, ['-1', '0'], false);\n    }\n\n    public override getSupportedFeatures(): MinerFeatureKey[] {\n        return [\n            MinerFeatureKey.running,\n            MinerFeatureKey.rawStats,\n            MinerFeatureKey.version,\n            MinerFeatureKey.totalHashrate,\n        ];\n    }\n\n    public override getLoggerName(): string {\n        return `${super.getLoggerName()}ClaymoreMiner[${this.settings.host}:${this.settings.port}]`;\n    }\n\n    public override getCliArgs(): string[] {\n        return [`--cm_api_listen=0.0.0.0:${this.settings.port}`, `--cm_api_password=${this.settings.password}`];\n    }\n\n    private async sendCommand<T = void>(\n        method: ClaymoreCommandMethod,\n        params?: string[],\n        expectResponse: boolean = true,\n    ): Promise<T> {\n        return await sendSocketCommand(\n            this.logger,\n            this.settings.host,\n            this.settings.port,\n            {\n                id: 0,\n                jsonrpc: '2.0',\n                psw: this.settings.password,\n                method,\n                params,\n            },\n            expectResponse,\n        );\n    }\n\n    // public to allow unit tests\n    public parseMinerGetStat1(response: MinerGetStat1Response): ParsedMinerGetStat1Response {\n        const [\n            minerVersion,\n            runningTime,\n            ethTotalStats,\n            ethDetailedHashrate,\n            dcrTotalStats,\n            dcrDetailedHashrate,\n            temperatureAndFanSpeed,\n            currentMiningPool,\n            invalidSharesAndPoolSwitches,\n        ] = response.result;\n\n        const [ethHashrate, ethShares, ethRejectedShares] = (ethTotalStats || '0;0;0').split(';').map(safeParseInt);\n        const [dcrHashrate, dcrShares, dcrRejectedShares] = (dcrTotalStats || '0;0;0').split(';').map(safeParseInt);\n        const [ethInvalidShares, ethPoolSwitches, dcrInvalidShares, dcrPoolSwitches] = (\n            invalidSharesAndPoolSwitches || '0;0;0;0'\n        )\n            .split(';')\n            .map(safeParseInt);\n\n        const gpuInfo = (temperatureAndFanSpeed || '').split(';').reduce<\n            Array<{\n                temperature: number;\n                fanSpeed: number;\n            }>\n        >((acc, value, index, array) => {\n            if (index % 2 === 0) {\n                const temperature = safeParseInt(value);\n                const fanSpeed = safeParseInt(array[index + 1]);\n                if (temperature !== 0 || fanSpeed !== 0) {\n                    acc.push({ temperature, fanSpeed });\n                }\n            }\n            return acc;\n        }, []);\n\n        return {\n            minerVersion: minerVersion || '',\n            runningTimeMinutes: safeParseInt(runningTime),\n            ethTotal: {\n                hashrate: ethHashrate,\n                shares: ethShares,\n                rejectedShares: ethRejectedShares,\n            },\n            ethDetailedHashrate: ethDetailedHashrate ? ethDetailedHashrate.split(';').map(safeParseInt) : [],\n            dcrTotal: {\n                hashrate: dcrHashrate,\n                shares: dcrShares,\n                rejectedShares: dcrRejectedShares,\n            },\n            dcrDetailedHashrate: dcrDetailedHashrate ? dcrDetailedHashrate.split(';').filter(s => s !== '') : [],\n            gpuInfo,\n            currentMiningPool: currentMiningPool || '',\n            stats: {\n                ethInvalidShares,\n                ethPoolSwitches,\n                dcrInvalidShares,\n                dcrPoolSwitches,\n            },\n        };\n    }\n\n    // public to allow unit tests\n    public parseMinerGetStat2(response: MinerGetStat2Response): ParsedMinerGetStat2Response {\n        const parsedStat1 = this.parseMinerGetStat1(response as unknown as MinerGetStat1Response);\n        const [\n            ,\n            ,\n            ,\n            ,\n            ,\n            ,\n            ,\n            ,\n            ,\n            ethAcceptedShares,\n            ethRejectedShares,\n            ethInvalidShares,\n            dcrAcceptedShares,\n            dcrRejectedShares,\n            dcrInvalidShares,\n            pciBusIndexes,\n        ] = response.result;\n\n        const parseShares = (shares: string) => (shares ? shares.split(';').map(safeParseInt) : []);\n\n        return {\n            ...parsedStat1,\n            ethAcceptedShares: parseShares(ethAcceptedShares),\n            ethRejectedShares: parseShares(ethRejectedShares),\n            ethInvalidShares: parseShares(ethInvalidShares),\n            dcrAcceptedShares: parseShares(dcrAcceptedShares),\n            dcrRejectedShares: parseShares(dcrRejectedShares),\n            dcrInvalidShares: parseShares(dcrInvalidShares),\n            pciBusIndexes: parseShares(pciBusIndexes),\n        };\n    }\n}\n\nexport interface MinerGetStat1Response {\n    id: number;\n    jsonrpc: string;\n    result: [\n        string, // Miner version\n        string, // Running time in minutes\n        string, // Total ETH hashrate, shares, rejected shares\n        string, // Detailed ETH hashrate for all GPUs\n        string, // Total DCR hashrate, shares, rejected shares\n        string, // Detailed DCR hashrate for all GPUs\n        string, // Temperature and Fan speed pairs for all GPUs\n        string, // Current mining pool(s)\n        string, // ETH invalid shares, pool switches, DCR invalid shares, pool switches\n    ];\n}\n\nexport interface MinerGetStat2Response {\n    id: number;\n    jsonrpc: string;\n    result: [\n        ...MinerGetStat1Response['result'],\n        string, // ETH accepted shares for every GPU\n        string, // ETH rejected shares for every GPU\n        string, // ETH invalid shares for every GPU\n        string, // DCR accepted shares for every GPU\n        string, // DCR rejected shares for every GPU\n        string, // DCR invalid shares for every GPU\n        string, // PCI bus index for every GPU\n    ];\n}\n\n// Parsed interfaces\ninterface ParsedMinerGetStat1Response {\n    minerVersion: string;\n    runningTimeMinutes: number;\n    ethTotal: {\n        // actually \"ETH hashrate\" also means other hashing algorithms\n        // in kH/s\n        hashrate: number;\n\n        shares: number;\n        rejectedShares: number;\n    };\n    ethDetailedHashrate: number[];\n    dcrTotal: {\n        hashrate: number;\n        shares: number;\n        rejectedShares: number;\n    };\n    dcrDetailedHashrate: string[];\n    gpuInfo: Array<{\n        temperature: number;\n        fanSpeed: number;\n    }>;\n    currentMiningPool: string;\n    stats: {\n        ethInvalidShares: number;\n        ethPoolSwitches: number;\n        dcrInvalidShares: number;\n        dcrPoolSwitches: number;\n    };\n}\n\ninterface ParsedMinerGetStat2Response extends ParsedMinerGetStat1Response {\n    ethAcceptedShares: number[];\n    ethRejectedShares: number[];\n    ethInvalidShares: number[];\n    dcrAcceptedShares: number[];\n    dcrRejectedShares: number[];\n    dcrInvalidShares: number[];\n    pciBusIndexes: number[];\n}\n"],
  "mappings": "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",
  "names": ["ClaymoreCommandMethod"]
}

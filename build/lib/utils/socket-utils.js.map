{
  "version": 3,
  "sources": ["../../../src/lib/utils/socket-utils.ts"],
  "sourcesContent": ["import {Socket} from 'node:net';\nimport {Logger} from '../miner/model/Logger';\n\n/**\n * Utility function to send a command to a socket server (and wait for a response - if expected)\n * (connection is closed after the response is received or after a timeout)\n *\n * @param logger - logger to use\n * @param host - host to connect to\n * @param port - port to connect to\n * @param data - data to send\n * @param expectResponse - whether to expect a response\n */\nexport async function sendSocketCommand<T = void>(\n    logger: Logger,\n    host: string,\n    port: number,\n    data: object,\n    expectResponse: boolean = true\n): Promise<T> {\n    logger.debug(`sendCommand: ${JSON.stringify(data)}`);\n\n    let handled = false;\n    const socket: Socket = new Socket();\n\n    return new Promise<T>((resolve, reject) => {\n        socket.on('connect', () => {\n            const cmd = JSON.stringify(data) + '\\n';\n            logger.debug(`connected, sending cmd now ...: ${cmd}`);\n            socket.write(cmd, (err) => {\n                if (err) {\n                    logger.error(err.message);\n                    reject(err.message);\n                } else {\n                    if (!expectResponse) {\n                        resolve(undefined as T);\n                    }\n                }\n            });\n        });\n\n        socket.on('timeout', () => {\n\n            logger.warn('socket timeout');\n            reject('socket timeout');\n        });\n\n        socket.on('data', (data) => {\n            logger.debug(`received: ${data.toString()}`);\n            try {\n                // BOS would create error while parsing JSON: uncaught exception: Unexpected non-whitespace character after JSON at position 932\n                // Convert buffer to string, remove all non-ASCII characters, trim whitespace, and remove unexpected characters after JSON data\n                const jsonString = data.toString()\n                    .replace(/[^\\x00-\\x7F]/g, '')\n                    .trim()\n                    .replace(/[^}\\]]*$/, '');\n\n                const d = JSON.parse(jsonString);\n                resolve(d as T);\n            } catch (e) {\n                const errMsg = `Failed to parse JSON: ${e}`;\n                logger.error(errMsg);\n                reject(errMsg);\n            }\n        });\n\n        socket.on('close', () => {\n        }); // discard\n\n        socket.on('error', (err) => {\n            logger.error(err.message);\n            reject(`socket error: ${err.message}`);\n        });\n\n        socket.setTimeout(3000);\n        socket.connect(port, host);\n\n        // socket timeout alone does is not enough\n        setTimeout(() => {\n            if (!handled) {\n                const msg = `timeout handling socket command: ${JSON.stringify(data)}. maybe the password is wrong?`;\n                logger.warn(msg);\n                reject(msg);\n            }\n        }, 3000)\n    }).finally(() => {\n        handled = true;\n        socket.end();\n        socket.destroy();\n    });\n}\n\n/**\n * Utility function to send a raw string command to a socket server\n * (connection is closed after the response is received or after a timeout)\n * Used for Avalon ascset commands that don't use JSON format\n *\n * @param logger - logger to use\n * @param host - host to connect to\n * @param port - port to connect to\n * @param command - raw command string to send\n * @param expectResponse - whether to expect a response\n */\nexport async function sendRawSocketCommand<T = void>(\n    logger: Logger,\n    host: string,\n    port: number,\n    command: string,\n    expectResponse: boolean = false\n): Promise<T> {\n    logger.debug(`sendRawCommand: ${command}`);\n\n    let handled = false;\n    const socket: Socket = new Socket();\n\n    return new Promise<T>((resolve, reject) => {\n        socket.on('connect', () => {\n            const cmd = command + '\\n';\n            logger.debug(`connected, sending raw cmd now ...: ${cmd}`);\n            socket.write(cmd, (err) => {\n                if (err) {\n                    logger.error(err.message);\n                    handled = true;\n                    reject(err.message);\n                } else {\n                    if (!expectResponse) {\n                        handled = true;\n                        resolve(undefined as T);\n                    }\n                }\n            });\n        });\n\n        socket.on('timeout', () => {\n            logger.warn('socket timeout');\n            handled = true;\n            reject('socket timeout');\n        });\n\n        socket.on('data', (data) => {\n            logger.debug(`received: ${data.toString()}`);\n            try {\n                const jsonString = data.toString()\n                    .replace(/[^\\x00-\\x7F]/g, '')\n                    .trim()\n                    .replace(/[^}\\]]*$/, '');\n\n                const d = JSON.parse(jsonString);\n                handled = true;\n                resolve(d as T);\n            } catch (e) {\n                const errMsg = `Failed to parse JSON: ${e}`;\n                logger.error(errMsg);\n                handled = true;\n                reject(errMsg);\n            }\n        });\n\n        socket.on('close', () => {\n        }); // discard\n\n        socket.on('error', (err) => {\n            logger.error(err.message);\n            handled = true;\n            reject(`socket error: ${err.message}`);\n        });\n\n        socket.setTimeout(3000);\n        socket.connect(port, host);\n\n        // socket timeout alone is not enough\n        setTimeout(() => {\n            if (!handled) {\n                const msg = `timeout handling raw socket command: ${command}`;\n                logger.warn(msg);\n                handled = true;\n                reject(msg);\n            }\n        }, 3000);\n    }).finally(() => {\n        socket.end();\n        socket.destroy();\n    });\n}"],
  "mappings": "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",
  "names": ["data"]
}

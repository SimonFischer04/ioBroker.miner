{
  "version": 3,
  "sources": ["../../../src/lib/utils/socket-utils.ts"],
  "sourcesContent": ["import { Socket } from 'node:net';\nimport type { Logger } from '../miner/model/Logger';\n\n/**\n * Utility function to send a command to a socket server (and wait for a response - if expected)\n * (connection is closed after the response is received or after a timeout)\n *\n * @param logger - logger to use\n * @param host - host to connect to\n * @param port - port to connect to\n * @param data - data to send\n * @param expectResponse - whether to expect a response\n */\nexport async function sendSocketCommand<T = void>(\n    logger: Logger,\n    host: string,\n    port: number,\n    data: object,\n    expectResponse: boolean = true,\n): Promise<T> {\n    logger.debug(`sendCommand: ${JSON.stringify(data)}`);\n\n    let handled = false;\n    const socket: Socket = new Socket();\n\n    return new Promise<T>((resolve, reject) => {\n        socket.on('connect', () => {\n            const cmd = `${JSON.stringify(data)}\\n`;\n            logger.debug(`connected, sending cmd now ...: ${cmd}`);\n            socket.write(cmd, err => {\n                if (err) {\n                    logger.error(err.message);\n                    reject(new Error(err.message));\n                } else {\n                    if (!expectResponse) {\n                        resolve(undefined as T);\n                    }\n                }\n            });\n        });\n\n        socket.on('timeout', () => {\n            logger.warn('socket timeout');\n            reject(new Error('socket timeout'));\n        });\n\n        socket.on('data', data => {\n            logger.debug(`received: ${data.toString()}`);\n            try {\n                // BOS would create error while parsing JSON: uncaught exception: Unexpected non-whitespace character after JSON at position 932\n                // Convert buffer to string, remove all non-ASCII characters, trim whitespace, and remove unexpected characters after JSON data\n                const jsonString = data\n                    .toString()\n                    // eslint-disable-next-line no-control-regex\n                    .replace(/[^\\x00-\\x7F]/g, '')\n                    .trim()\n                    .replace(/[^}\\]]*$/, '');\n\n                const d = JSON.parse(jsonString);\n                resolve(d as T);\n            } catch (e) {\n                const errMsg = `Failed to parse JSON: ${String(e)}`;\n                logger.error(errMsg);\n                reject(new Error(errMsg));\n            }\n        });\n\n        socket.on('close', () => {}); // discard\n\n        socket.on('error', err => {\n            logger.error(err.message);\n            reject(new Error(`socket error: ${err.message}`));\n        });\n\n        socket.setTimeout(3000);\n        socket.connect(port, host);\n\n        // socket timeout alone does is not enough\n        setTimeout(() => {\n            if (!handled) {\n                const msg = `timeout handling socket command: ${JSON.stringify(data)}. maybe the password is wrong?`;\n                logger.warn(msg);\n                reject(new Error(msg));\n            }\n        }, 3000);\n    }).finally(() => {\n        handled = true;\n        socket.end();\n        socket.destroy();\n    });\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBAAuB;AAavB,eAAsB,kBAClB,QACA,MACA,MACA,MACA,iBAA0B,MAChB;AACV,SAAO,MAAM,gBAAgB,KAAK,UAAU,IAAI,CAAC,EAAE;AAEnD,MAAI,UAAU;AACd,QAAM,SAAiB,IAAI,uBAAO;AAElC,SAAO,IAAI,QAAW,CAAC,SAAS,WAAW;AACvC,WAAO,GAAG,WAAW,MAAM;AACvB,YAAM,MAAM,GAAG,KAAK,UAAU,IAAI,CAAC;AAAA;AACnC,aAAO,MAAM,mCAAmC,GAAG,EAAE;AACrD,aAAO,MAAM,KAAK,SAAO;AACrB,YAAI,KAAK;AACL,iBAAO,MAAM,IAAI,OAAO;AACxB,iBAAO,IAAI,MAAM,IAAI,OAAO,CAAC;AAAA,QACjC,OAAO;AACH,cAAI,CAAC,gBAAgB;AACjB,oBAAQ,MAAc;AAAA,UAC1B;AAAA,QACJ;AAAA,MACJ,CAAC;AAAA,IACL,CAAC;AAED,WAAO,GAAG,WAAW,MAAM;AACvB,aAAO,KAAK,gBAAgB;AAC5B,aAAO,IAAI,MAAM,gBAAgB,CAAC;AAAA,IACtC,CAAC;AAED,WAAO,GAAG,QAAQ,CAAAA,UAAQ;AACtB,aAAO,MAAM,aAAaA,MAAK,SAAS,CAAC,EAAE;AAC3C,UAAI;AAGA,cAAM,aAAaA,MACd,SAAS,EAET,QAAQ,iBAAiB,EAAE,EAC3B,KAAK,EACL,QAAQ,YAAY,EAAE;AAE3B,cAAM,IAAI,KAAK,MAAM,UAAU;AAC/B,gBAAQ,CAAM;AAAA,MAClB,SAAS,GAAG;AACR,cAAM,SAAS,yBAAyB,OAAO,CAAC,CAAC;AACjD,eAAO,MAAM,MAAM;AACnB,eAAO,IAAI,MAAM,MAAM,CAAC;AAAA,MAC5B;AAAA,IACJ,CAAC;AAED,WAAO,GAAG,SAAS,MAAM;AAAA,IAAC,CAAC;AAE3B,WAAO,GAAG,SAAS,SAAO;AACtB,aAAO,MAAM,IAAI,OAAO;AACxB,aAAO,IAAI,MAAM,iBAAiB,IAAI,OAAO,EAAE,CAAC;AAAA,IACpD,CAAC;AAED,WAAO,WAAW,GAAI;AACtB,WAAO,QAAQ,MAAM,IAAI;AAGzB,eAAW,MAAM;AACb,UAAI,CAAC,SAAS;AACV,cAAM,MAAM,oCAAoC,KAAK,UAAU,IAAI,CAAC;AACpE,eAAO,KAAK,GAAG;AACf,eAAO,IAAI,MAAM,GAAG,CAAC;AAAA,MACzB;AAAA,IACJ,GAAG,GAAI;AAAA,EACX,CAAC,EAAE,QAAQ,MAAM;AACb,cAAU;AACV,WAAO,IAAI;AACX,WAAO,QAAQ;AAAA,EACnB,CAAC;AACL;",
  "names": ["data"]
}
